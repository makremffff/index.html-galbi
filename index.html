<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Mini App â€“ Snow</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --accent:#00d9ff;
      --text:#fff;
      --card-bg:#ffffff1a;
      --soft-btn:#00d9ff33;
      --soft-btn-h:#00d9ff44;
      --dis:#ffffff22;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden;background:linear-gradient(135deg,#1e3c72,#2a5298);font-family:Arial,Helvetica,sans-serif;color:var(--text)}
    .snow-container{position:absolute;inset:0;pointer-events:none}
    .snowflake{position:absolute;top:-50px;font-size:1rem;animation:fall linear infinite}
    .snowflake::before{content:"â„";color:#fff}
    @keyframes fall{to{transform:translateY(calc(100vh + 50px))}}
    .game-card{position:absolute;top:12px;left:12px;background:var(--card-bg);backdrop-filter:blur(8px);border:1px solid #ffffff30;border-radius:14px;padding:10px 14px;font-size:13px;display:flex;flex-direction:column;gap:4px;user-select:none}
    .game-card .row{display:flex;align-items:center;justify-content:space-between;min-width:110px}
    .game-card .label{opacity:.75;font-size:11px}
    .game-card .val{font-weight:700;color:var(--accent)}
    #storeBtnWrap{position:absolute;top:102px;left:12px}
    #withdrawBtnWrap{position:absolute;top:102px;left:12px;margin-top:44px}
    #inviteBtnWrap{position:absolute;top:102px;left:12px;margin-top:88px}
    .btn-3d{
      font-size:12px;
      padding:6px 14px;
      border-radius:16px;
      box-shadow:0 4px 0 var(--accent);
      transition:all .1s ease;
      border:1px solid var(--accent);
      background:var(--soft-btn);
      color:var(--text);
      cursor:pointer;
    }
    .btn-3d:active{
      transform:translateY(2px);
      box-shadow:0 2px 0 var(--accent);
    }
    .user-card{position:absolute;top:12px;right:12px;text-align:center;font-size:11px}
    .user-card img{width:48px;height:48px;border-radius:50%;border:2px solid #ffffff50;object-fit:cover;display:block;margin:0 auto 4px}
    .user-card #userId{opacity:.7;font-size:10px;direction:ltr;unicode-bidi:plaintext;margin-top:2px}
    .soft-btn{background:var(--soft-btn);border:1px solid var(--accent);color:var(--text);font-size:13px;font-weight:600;padding:10px 20px;border-radius:25px;backdrop-filter:blur(6px);cursor:pointer;transition:background .2s}
    .soft-btn:active{background:var(--soft-btn-h)}
    #btnGroup{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);display:flex;gap:8px}
    .page{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;visibility:hidden;opacity:0;transform:translateX(20px);transition:visibility 0s .6s, opacity .6s, transform .6s}
    .page.active{visibility:visible;opacity:1;transform:translateX(0);transition:visibility 0s, opacity .6s, transform .6s}
    #gameScreen{display:none;flex-direction:column;align-items:center;justify-content:center;height:100%;position:relative}
    #timer{position:absolute;top:20px;font-size:24px;font-weight:700;color:var(--accent)}
    #score{position:absolute;bottom:100px;font-size:20px}
    .fruit{position:absolute;top:-80px;font-size:60px;cursor:pointer;user-select:none;animation:fruitFall linear;pointer-events:auto;touch-action:manipulation}
    @keyframes fruitFall{to{transform:translateY(calc(100vh + 100px))}}
    #page1 .back-btn{display:none!important}
    #inviteTop{margin-bottom:15px;font-size:18px}
    #inviteTop b{color:var(--accent)}
    #copyMsg{margin-top:6px;font-size:12px;opacity:0;transition:opacity .3s}
  </style>
</head>
<body>

<div id="page1" class="page active">
  <div class="snow-container" id="snowContainer"></div>
  <div class="game-card">
    <div class="row"><span class="label">â­ Points</span><span class="val" id="points">0</span></div>
    <div class="row"><span class="label">ğŸ’ USDT</span><span class="val" id="usdt">0</span></div>
    <div class="row"><span class="label">ğŸ« Tickets</span><span class="val" id="tickets">0</span></div>
  </div>
  <div id="storeBtnWrap"><button id="storeBtn" class="btn-3d" onclick="openPage('store')">STORE</button></div>
  <div id="withdrawBtnWrap"><button id="withdrawBtn" class="btn-3d" onclick="openPage('withdraw')">Withdraw</button></div>
  <div id="inviteBtnWrap"><button id="inviteBtn" class="btn-3d" onclick="openPage('invite')">Invite Friend</button></div>
  <div class="user-card"><img id="userImg" src="" alt=""><div id="userName"></div><div id="userId"></div></div>
  <div id="btnGroup">
    <button class="soft-btn btn-3d" onclick="checkPlay()">Play</button>
    <button class="soft-btn btn-3d" onclick="openPage('swap')">Swap</button>
    <button class="soft-btn btn-3d" onclick="openPage('addTask')">Add Task</button>
    <button class="soft-btn btn-3d" onclick="openPage('task')">Task</button>
  </div>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<div id="game" class="page">
  <div id="gameScreen">
    <div id="timer">30</div>
    <div id="score">Score: 0</div>
  </div>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<div id="swap" class="page">
  <h2 style="margin-bottom:20px">Swap</h2>
  <p>Ù…Ø­ØªÙˆÙ‰ ØµÙØ­Ø© Swap Ø³ÙŠÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<div id="addTask" class="page">
  <h2 style="margin-bottom:20px">Add Task</h2>
  <p>Ù…Ø­ØªÙˆÙ‰ ØµÙØ­Ø© Add Task Ø³ÙŠÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<div id="task" class="page">
  <h2 style="margin-bottom:20px">Task</h2>
  <p>Ù…Ø­ØªÙˆÙ‰ ØµÙØ­Ø© Task Ø³ÙŠÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<div id="store" class="page">
  <h2 style="font-size:24px; color:var(--accent); text-shadow:0 0 4px var(--accent); margin-bottom:30px;">STORE</h2>
  <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
    <button id="adBtn" class="soft-btn btn-3d" onclick="watchAd()" style="min-width:160px;">Watch Ad</button>
    <div style="font-size:12px; opacity:0.7;">+1 ğŸ«</div>
  </div>
  <div style="display:flex; gap:15px; margin-top:20px;">
    <div style="display:flex; flex-direction:column; align-items:center;">
      <button class="soft-btn btn-3d" onclick="buyTickets(500)">Buy 500 ğŸ«</button>
      <span style="margin-top:6px; font-size:16px; opacity:0.8;">10 â­</span>
    </div>
    <div style="display:flex; flex-direction:column; align-items:center;">
      <button class="soft-btn btn-3d" onclick="buyTickets(2500)">Buy 2500 ğŸ«</button>
      <span style="margin-top:6px; font-size:16px; opacity:0.8;">50 â­</span>
    </div>
    <div style="display:flex; flex-direction:column; align-items:center;">
      <button class="soft-btn btn-3d" onclick="buyTickets(6000)">Buy 6000 ğŸ«</button>
      <span style="margin-top:6px; font-size:16px; opacity:0.8;">100 â­</span>
    </div>
  </div>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<div id="withdraw" class="page">
  <h2 style="margin-bottom:20px">Withdraw</h2>
  <p>Ù…Ø­ØªÙˆÙ‰ ØµÙØ­Ø© Withdraw Ø³ÙŠÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<div id="invite" class="page">
  <h2 style="margin-bottom:10px">Invite Friends</h2>
  <div id="inviteTop">Total Invites: <b id="inviteCount">0</b></div>
  <p style="margin-bottom:30px; font-size:14px; opacity:0.85;">Each invite gives you <b>10 Tickets</b> instantly!</p>
  <button id="copyBtn" class="soft-btn btn-3d" style="min-width:160px;" onclick="copyInvite()">Copy Link</button>
  <div id="copyMsg">âœ… Link copied!</div>
  <button class="soft-btn btn-3d" onclick="shareInvite()" style="min-width:160px;">Share on Telegram</button>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<script>
const API_BASE = '/api/index.js';
let currentUser = null;
let score = 0, gameTimer, timeLeft = 30, gameActive = false;
let points = 0, tickets = 0, usdt = 0;
let inviteLink = '';
let adsReadyAfter = 0, watching = false;

// Ø¯ÙˆØ§Ù„ Fetch Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ Backend
async function apiCall(action, data = {}) {
  try {
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id || 123456789;
    const response = await fetch(`${API_BASE}?action=${action}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ...data,
        user_id: userId,
        initData: Telegram.WebApp.initData
      })
    });
    return await response.json();
  } catch (error) {
    console.error('API Error:', error);
    return { success: false, error: 'Network error' };
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function loadUserData() {
  const data = await apiCall('getUserData');
  if (data.success) {
    currentUser = data.user;
    points = data.user.points || 0;
    usdt = data.user.usdt || 0;
    tickets = data.user.tickets || 0;
    
    document.getElementById('points').textContent = points;
    document.getElementById('usdt').textContent = usdt;
    document.getElementById('tickets').textContent = tickets;
    
    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    if (Telegram.WebApp.initDataUnsafe?.user) {
      const user = Telegram.WebApp.initDataUnsafe.user;
      document.getElementById('userName').textContent = user.first_name || 'User';
      document.getElementById('userId').textContent = `ID: ${user.id}`;
      if (user.photo_url) {
        document.getElementById('userImg').src = user.photo_url;
      }
    }
  }
}

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
async function registerUser(refBy) {
  const result = await apiCall('referral', { referred_by: refBy });
  if (result.success) {
    console.log('User registered with referral:', refBy);
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
    await loadUserData();
  }
}

async function loadInvite() {
  const data = await apiCall('getInviteData');
  if (data.success) {
    document.getElementById('inviteCount').textContent = data.inviteCount || 0;
    const userId = Telegram.WebApp.initDataUnsafe?.user?.id || 123456789;
    inviteLink = data.inviteLink || `https://t.me/Game_win_usdtBot/earn?startapp=ref_${userId}`;
  }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©
async function startGameSession() {
  const result = await apiCall('startGame');
  return result.success;
}

async function endGameSession(score) {
  const result = await apiCall('endGame', { score });
  if (result.success) {
    return result.points || score * 2.5;
  }
  return score * 2.5;
}

async function updateUserData() {
  const data = await apiCall('getUserData');
  if (data.success) {
    points = data.user.points || 0;
    tickets = data.user.tickets || 0;
    usdt = data.user.usdt || 0;
    
    document.getElementById('points').textContent = points;
    document.getElementById('tickets').textContent = tickets;
    document.getElementById('usdt').textContent = usdt;
  }
}

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„ØªØ°Ø§ÙƒØ±
async function processPayment(ticketAmount, starCost) {
  const result = await apiCall('processPayment', { 
    ticket_amount: ticketAmount, 
    star_cost: starCost 
  });
  
  if (result.success) {
    await updateUserData();
  }
  
  return result.success;
}

async function watchAdReward() {
  const result = await apiCall('watchAd');
  if (result.success) {
    await updateUserData();
  }
  return result.success;
}

// Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØµÙˆØªÙŠØ© ÙˆØ§Ù„Ø±Ø³ÙˆÙ…ÙŠØ©
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playPop(){
  const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
  osc.type = 'sine'; 
  osc.frequency.value = 800;
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(); 
  osc.stop(audioCtx.currentTime + 0.08);
}

// ØªØ£Ø«ÙŠØ± Ø§Ù„Ø«Ù„Ø¬
const container = document.getElementById('snowContainer');
setInterval(() => {
  const f = document.createElement('div'); 
  f.className = 'snowflake';
  f.style.left = Math.random() * 100 + '%'; 
  f.style.opacity = Math.random() * 0.6 + 0.4;
  f.style.fontSize = (Math.random() * 0.8 + 0.8) + 'rem'; 
  f.style.animationDuration = (Math.random() * 3 + 2) + 's';
  f.style.animationDelay = Math.random() * 2 + 's'; 
  container.appendChild(f);
  setTimeout(() => f.remove(), 8000);
}, 150);

// Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©
const fruits = ['ğŸ','ğŸŠ','ğŸŒ','ğŸ‡','ğŸ“','ğŸ’','ğŸ¥','ğŸ‘','ğŸ','ğŸ¥­','ğŸ‰','ğŸˆ','ğŸ','ğŸ‹','ğŸ¥¥','ğŸ¥‘','ğŸŒ½','ğŸ¥•','ğŸ¥”','ğŸ ','ğŸ¥’','ğŸ¥¬','ğŸ¥¦','ğŸ§„','ğŸ§…','ğŸ„','ğŸ¥œ','ğŸŒ°','ğŸ','ğŸ¥','ğŸ¥–','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ§ˆ','ğŸ¥','ğŸ§‡','ğŸ¥“','ğŸ”','ğŸŸ','ğŸ•','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸ§†','ğŸ¥™','ğŸ¥—','ğŸœ','ğŸ','ğŸ ','ğŸ¤','ğŸ£','ğŸ±','ğŸ›','ğŸš','ğŸ˜','ğŸ¥','ğŸ¥ ','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ¥§','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥›','ğŸ¼','â˜•','ğŸµ','ğŸ§ƒ','ğŸ¥¤','ğŸ§‹','ğŸ¶','ğŸº','ğŸ»','ğŸ¥‚','ğŸ·','ğŸ¥ƒ','ğŸ¸','ğŸ¹','ğŸ§‰','ğŸ¾','ğŸ§Š','ğŸ¥„','ğŸ´','ğŸ½ï¸','ğŸ¥£','ğŸ¥¡','ğŸ¥¢','ğŸ§‚'];

function createFruit(){
  if(!gameActive) return;
  const f = document.createElement('div'); 
  f.className = 'fruit';
  f.textContent = fruits[Math.floor(Math.random() * fruits.length)];
  f.style.left = Math.random() * (window.innerWidth - 60) + 'px';
  f.style.animationDuration = (Math.random() * 0.8 + 0.8) + 's';
  
  f.ontouchstart = f.onmousedown = function(e){
    e.preventDefault(); 
    playPop(); 
    score++;
    document.getElementById('score').textContent = 'Score: ' + score;
    f.style.transform = 'scale(0)'; 
    f.style.opacity = '0';
    setTimeout(() => f.remove(), 150); 
    return false;
  };
  
  document.body.appendChild(f); 
  setTimeout(() => {
    if (f.parentNode) {
      f.remove();
    }
  }, 1800);
}

async function startGame(){
  const canPlay = await startGameSession();
  if (!canPlay) {
    alert("Cannot start game session. Please try again.");
    return;
  }

  score = 0; 
  timeLeft = 30; 
  gameActive = true;
  document.getElementById('score').textContent = 'Score: 0';
  document.getElementById('timer').textContent = timeLeft;
  document.getElementById('gameScreen').style.display = 'flex';
  
  const fruitInterval = setInterval(() => {
    if(!gameActive) {
      clearInterval(fruitInterval);
      return;
    }
    createFruit();
  }, 33);
  
  gameTimer = setInterval(() => {
    timeLeft--;
    document.getElementById('timer').textContent = timeLeft;
    if(timeLeft <= 0){
      gameActive = false; 
      clearInterval(gameTimer); 
      clearInterval(fruitInterval);
      
      endGameSession(score).then(async (gamePoints) => {
        await updateUserData();
        
        const msg = document.createElement('div');
        msg.innerHTML = `ğŸ‰ Congrats! You got <b>${gamePoints.toFixed(1)}</b> points!`;
        msg.style.cssText = `position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.7);color:var(--accent);padding:15px 25px;border-radius:15px;font-size:20px;text-align:center;z-index:9999;`;
        document.body.appendChild(msg);
        setTimeout(() => {
          msg.remove();
          openPage('page1');
        }, 2000);
      });
    }
  }, 1000);
}

function openPage(pageId){
  const current = document.querySelector('.page.active');
  const next = document.getElementById(pageId);
  if(current === next) return;
  
  current.classList.add('flip-out');
  next.classList.add('flip-in', 'active');
  
  if(pageId === 'game') startGame();
  if(pageId === 'invite') loadInvite();
  
  setTimeout(() => {
    current.classList.remove('active', 'flip-out');
    next.classList.remove('flip-in');
  }, 600);
}

function getStarCost(t){
  switch(t){
    case 500: return 10;
    case 2500: return 50;
    case 6000: return 100;
    default: return 0;
  }
}

async function buyTickets(ticketAmount){
  const starCost = getStarCost(ticketAmount);
  
  if (points < starCost) {
    alert("Not enough stars!");
    return;
  }

  const paymentSuccess = await processPayment(ticketAmount, starCost);
  
  if (paymentSuccess) {
    alert(`âœ… You successfully bought ${ticketAmount} ğŸ«!`);
  } else {
    alert("âŒ Payment failed.");
  }
}

function getRefParam() {
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
    const sp = Telegram.WebApp.initDataUnsafe.start_param;
    if (sp && sp.startsWith('ref_')) {
      const ref = sp.replace('ref_', '');
      if (/^\d+$/.test(ref)) return ref;
    }
  }
  if (location.hash.startsWith('#ref_')) {
    const ref = location.hash.split('#ref_')[1];
    if (/^\d+$/.test(ref)) return ref;
  }
  return null;
}

function copyInvite(){
  navigator.clipboard.writeText(inviteLink).then(() => {
    const m = document.getElementById('copyMsg');
    m.style.opacity = 1;
    setTimeout(() => m.style.opacity = 0, 1500);
  });
}

function shareInvite(){
  const text = `Join the game and earn tickets!`;
  const url = encodeURIComponent(inviteLink);
  Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${url}&text=${encodeURIComponent(text)}`);
}

async function watchAd(){
  const now = Date.now();
  if(watching || now < adsReadyAfter) return;
  
  watching = true;
  adBtn.disabled = true;
  
  const rewardSuccess = await watchAdReward();
  
  if (rewardSuccess) {
    adsReadyAfter = Date.now() + 5000;
  }
  
  watching = false;
  adBtn.disabled = false;
}

async function checkPlay(){
  if(tickets <= 0){
    alert("You need at least 1 ticket to play!");
    return;
  }
  
  openPage('game');
}

// Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
(async function init(){
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
  
  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Telegram
  if (Telegram.WebApp.initDataUnsafe?.user) {
    const user = Telegram.WebApp.initDataUnsafe.user;
    document.getElementById('userName').textContent = user.first_name || 'User';
    document.getElementById('userId').textContent = `ID: ${user.id}`;
    if (user.photo_url) {
      document.getElementById('userImg').src = user.photo_url;
    }
  }
  
  await loadUserData();
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª
  const ref = getRefParam();
  if (ref) {
    await registerUser(ref);
  }
})();
</script>
</body>
</html>