<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Mini App â€“ Snow</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --accent:#00d9ff;
      --text:#fff;
      --card-bg:#ffffff1a;
      --soft-btn:#00d9ff33;
      --soft-btn-h:#00d9ff44;
      --dis:#ffffff22;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden;background:linear-gradient(135deg,#1e3c72,#2a5298);font-family:Arial,Helvetica,sans-serif;color:var(--text)}

    /* Ø«Ù„Ø¬ */
    .snow-container{position:absolute;inset:0;pointer-events:none}
    .snowflake{position:absolute;top:-50px;font-size:1rem;animation:fall linear infinite}
    .snowflake::before{content:"â„";color:#fff}
    @keyframes fall{to{transform:translateY(calc(100vh + 50px))}}

    /* game-card / user-card */
    .game-card{position:absolute;top:12px;left:12px;background:var(--card-bg);backdrop-filter:blur(8px);border:1px solid #ffffff30;border-radius:14px;padding:10px 14px;font-size:13px;display:flex;flex-direction:column;gap:4px;user-select:none}
    .game-card .row{display:flex;align-items:center;justify-content:space-between;min-width:110px}
    .game-card .label{opacity:.75;font-size:11px}
    .game-card .val{font-weight:700;color:var(--accent)}

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¯Ø¹ÙˆØ© */
    #storeBtnWrap{position:absolute;top:102px;left:12px}
    #withdrawBtnWrap{position:absolute;top:102px;left:12px;margin-top:44px}
    #inviteBtnWrap{position:absolute;top:102px;left:12px;margin-top:88px}

    /* 3D push */
    .btn-3d{
      font-size:12px;
      padding:6px 14px;
      border-radius:16px;
      box-shadow:0 4px 0 var(--accent);
      transition:all .1s ease;
      border:1px solid var(--accent);
      background:var(--soft-btn);
      color:var(--text);
      cursor:pointer;
    }
    .btn-3d:active{
      transform:translateY(2px);
      box-shadow:0 2px 0 var(--accent);
    }

    .user-card{position:absolute;top:12px;right:12px;text-align:center;font-size:11px}
    .user-card img{width:48px;height:48px;border-radius:50%;border:2px solid #ffffff50;object-fit:cover;display:block;margin:0 auto 4px}
    .user-card #userId{opacity:.7;font-size:10px;direction:ltr;unicode-bidi:plaintext;margin-top:2px}

    /* Ø£Ø²Ø±Ø§Ø± Ø£Ø³ÙÙ„ */
    .soft-btn{background:var(--soft-btn);border:1px solid var(--accent);color:var(--text);font-size:13px;font-weight:600;padding:10px 20px;border-radius:25px;backdrop-filter:blur(6px);cursor:pointer;transition:background .2s}
    .soft-btn:active{background:var(--soft-btn-h)}
    #btnGroup{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);display:flex;gap:8px}

    /* ØµÙØ­Ø§Øª */
    .page{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;visibility:hidden;opacity:0;transform:translateX(20px);transition:visibility 0s .6s, opacity .6s, transform .6s}
    .page.active{visibility:visible;opacity:1;transform:translateX(0);transition:visibility 0s, opacity .6s, transform .6s}

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© */
    #gameScreen{display:none;flex-direction:column;align-items:center;justify-content:center;height:100%;position:relative}
    #timer{position:absolute;top:20px;font-size:24px;font-weight:700;color:var(--accent)}
    #score{position:absolute;bottom:100px;font-size:20px}

    /* ÙÙˆØ§ÙƒÙ‡ */
    .fruit{position:absolute;top:-80px;font-size:60px;cursor:pointer;user-select:none;animation:fruitFall linear;pointer-events:auto;touch-action:manipulation}
    @keyframes fruitFall{to{transform:translateY(calc(100vh + 100px))}}

    /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Back Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    #page1 .back-btn{display:none!important}

    /* ØµÙØ­Ø© Invite */
    #inviteTop{margin-bottom:15px;font-size:18px}
    #inviteTop b{color:var(--accent)}
    #copyMsg{margin-top:6px;font-size:12px;opacity:0;transition:opacity .3s}
  </style>
</head>
<body>

<!-- ========== Ø§Ù„ØµÙØ­Ø© 1 (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) ========== -->
<div id="page1" class="page active">
  <div class="snow-container" id="snowContainer"></div>

  <div class="game-card">
    <div class="row"><span class="label">â­ Points</span><span class="val" id="points">0</span></div>
    <div class="row"><span class="label">ğŸ’ USDT</span><span class="val" id="usdt">0</span></div>
    <div class="row"><span class="label">ğŸ« Tickets</span><span class="val" id="tickets">0</span></div>
  </div>

  <!-- Ø²Ø± Ø§Ù„Ù…ØªØ¬Ø± -->
  <div id="storeBtnWrap">
    <button id="storeBtn" class="btn-3d" onclick="openPage('store')">STORE</button>
  </div>

  <!-- Ø²Ø± Withdraw -->
  <div id="withdrawBtnWrap">
    <button id="withdrawBtn" class="btn-3d" onclick="openPage('withdraw')">Withdraw</button>
  </div>

  <!-- Ø²Ø± Ø¯Ø¹ÙˆØ© ØµØ¯ÙŠÙ‚ -->
  <div id="inviteBtnWrap">
    <button id="inviteBtn" class="btn-3d" onclick="openPage('invite')">Invite Friend</button>
  </div>

  <div class="user-card">
    <img id="userImg" src="" alt=""><div id="userName"></div><div id="userId"></div>
  </div>

  <div id="btnGroup">
    <button class="soft-btn btn-3d" onclick="checkPlay()">Play</button>
    <button class="soft-btn btn-3d" onclick="openPage('swap')">Swap</button>
    <button class="soft-btn btn-3d" onclick="openPage('addTask')">Add Task</button>
    <button class="soft-btn btn-3d" onclick="openPage('task')">Task</button>
  </div>

  <!-- Ø²Ø± Back Ø«Ø§Ø¨Øª (Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) -->
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<!-- ========== ØµÙØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ========== -->
<div id="game" class="page">
  <div id="gameScreen">
    <div id="timer">30</div>
    <div id="score">Score: 0</div>
  </div>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<!-- ========== ØµÙØ­Ø© Swap ========== -->
<div id="swap" class="page">
  <h2 style="margin-bottom:20px">Swap</h2>
  <p>Ù…Ø­ØªÙˆÙ‰ ØµÙØ­Ø© Swap Ø³ÙŠÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<!-- ========== ØµÙØ­Ø© Add Task ========== -->
<div id="addTask" class="page">
  <h2 style="margin-bottom:20px">Add Task</h2>
  <p>Ù…Ø­ØªÙˆÙ‰ ØµÙØ­Ø© Add Task Ø³ÙŠÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<!-- ========== ØµÙØ­Ø© Task ========== -->
<div id="task" class="page">
  <h2 style="margin-bottom:20px">Task</h2>
  <p>Ù…Ø­ØªÙˆÙ‰ ØµÙØ­Ø© Task Ø³ÙŠÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<!-- ========== ØµÙØ­Ø© Ø§Ù„Ù…ØªØ¬Ø± ========== -->
<div id="store" class="page">
  <h2 style="font-size:24px; color:var(--accent); text-shadow:0 0 4px var(--accent); margin-bottom:30px;">STORE</h2>
  <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
    <button id="adBtn" class="soft-btn btn-3d" onclick="watchAd()" style="min-width:160px;">Watch Ad</button>
    <div style="font-size:12px; opacity:0.7;">+1 ğŸ«</div>
  </div>
  <div style="display:flex; gap:15px; margin-top:20px;">
    <div style="display:flex; flex-direction:column; align-items:center;">
      <button class="soft-btn btn-3d" onclick="buyTickets(500)">Buy 500 ğŸ«</button>
      <span style="margin-top:6px; font-size:16px; opacity:0.8;">10 â­</span>
    </div>
    <div style="display:flex; flex-direction:column; align-items:center;">
      <button class="soft-btn btn-3d" onclick="buyTickets(2500)">Buy 2500 ğŸ«</button>
      <span style="margin-top:6px; font-size:16px; opacity:0.8;">50 â­</span>
    </div>
    <div style="display:flex; flex-direction:column; align-items:center;">
      <button class="soft-btn btn-3d" onclick="buyTickets(6000)">Buy 6000 ğŸ«</button>
      <span style="margin-top:6px; font-size:16px; opacity:0.8;">100 â­</span>
    </div>
  </div>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<!-- ========== ØµÙØ­Ø© Withdraw ========== -->
<div id="withdraw" class="page">
  <h2 style="margin-bottom:20px">Withdraw</h2>
  <p>Ù…Ø­ØªÙˆÙ‰ ØµÙØ­Ø© Withdraw Ø³ÙŠÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<!-- ========== ØµÙØ­Ø© Invite Friend ========== -->
<div id="invite" class="page">
  <h2 style="margin-bottom:10px">Invite Friends</h2>

  <!-- Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª -->
  <div id="inviteTop">
    Total Invites: <b id="inviteCount">0</b>
  </div>

  <!-- Ø´Ø±Ø­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© -->
  <p style="margin-bottom:30px; font-size:14px; opacity:0.85;">
    Each invite gives you <b>10 Tickets</b> instantly!
  </p>

  <!-- Ø²Ø± Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· -->
  <button id="copyBtn" class="soft-btn btn-3d" style="min-width:160px;" onclick="copyInvite()">Copy Link</button>
  <div id="copyMsg">âœ… Link copied!</div>

  <!-- Ø²Ø± Ù…Ø´Ø§Ø±ÙƒØ© Ø³Ø±ÙŠØ¹Ø© -->
  <button class="soft-btn btn-3d" onclick="shareInvite()" style="min-width:160px;">Share on Telegram</button>

  <!-- Ø²Ø± Back -->
  <button class="soft-btn btn-3d back-btn" onclick="openPage('page1')" style="position:absolute; bottom:24px; left:50%; transform:translateX(-50%);">Back</button>
</div>

<script>
/* ========== Ø¯ÙˆØ§Ù„ Fetch Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ Backend ========== */
const API_BASE = '/api/index.js';

async function apiCall(action, data = {}) {
  try {
    const response = await fetch(`${API_BASE}?action=${action}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ...data,
        user_id: Telegram.WebApp.initDataUnsafe?.user?.id || 'unknown',
        initData: Telegram.WebApp.initData
      })
    });
    return await response.json();
  } catch (error) {
    console.error('API Error:', error);
    return { success: false, error: 'Network error' };
  }
}

/* ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ========== */
async function loadUserData() {
  const data = await apiCall('getUserData');
  if (data.success) {
    document.getElementById('points').textContent = data.points || 0;
    document.getElementById('usdt').textContent = data.usdt || 0;
    document.getElementById('tickets').textContent = data.tickets || 0;
    
    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (data.user) {
      document.getElementById('userName').textContent = data.user.first_name || 'User';
      document.getElementById('userId').textContent = `ID: ${data.user.id || 'unknown'}`;
      if (data.user.photo_url) {
        document.getElementById('userImg').src = data.user.photo_url;
      }
    }
  }
}

async function updateUserStats(points, usdt, tickets) {
  await apiCall('updateStats', { points, usdt, tickets });
}

/* ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© ========== */
async function startGameSession() {
  const result = await apiCall('startGame');
  return result.success;
}

async function endGameSession(score, earnedPoints) {
  const result = await apiCall('endGame', { score, earned_points: earnedPoints });
  return result.success;
}

/* ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ========== */
async function watchAdComplete() {
  const result = await apiCall('watchAd');
  if (result.success && result.tickets) {
    return result.tickets;
  }
  return 0;
}

async function processPurchase(ticketAmount, starCost) {
  const result = await apiCall('purchaseTickets', { 
    ticket_amount: ticketAmount, 
    star_cost: starCost 
  });
  return result.success;
}

/* ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª ========== */
async function registerReferral(refBy) {
  const result = await apiCall('referral', { referred_by: refBy });
  return result.success;
}

async function loadInviteData() {
  const result = await apiCall('getInviteData');
  if (result.success) {
    document.getElementById('inviteCount').textContent = result.invite_count || 0;
    return result.invite_link;
  }
  return '';
}

async function updateInviteCount() {
  const result = await apiCall('updateInviteCount');
  return result.invite_count || 0;
}

/* ========== Ù…Ø¤Ø«Ø±Ø§Øª ØµÙˆØªÙŠØ© Ø®ÙÙŠÙØ© ========== */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function playPop(){
  const osc=audioCtx.createOscillator(), gain=audioCtx.createGain();
  osc.type='sine'; osc.frequency.value=800;
  gain.gain.setValueAtTime(0.1,audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.08);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime+0.08);
}

/* ========== Ø«Ù„Ø¬ Ù…ØªØ­Ø±Ùƒ ========== */
const container=document.getElementById('snowContainer');
setInterval(()=>{
  const f=document.createElement('div'); f.className='snowflake';
  f.style.left=Math.random()*100+'%'; f.style.opacity=Math.random()*0.6+0.4;
  f.style.fontSize=(Math.random()*0.8+0.8)+'rem'; f.style.animationDuration=(Math.random()*3+2)+'s';
  f.style.animationDelay=Math.random()*2+'s'; container.appendChild(f);
  setTimeout(()=>f.remove(),8000);
},150);

/* ========== Ù„Ø¹Ø¨Ø© Ø§Ù„ÙÙˆØ§ÙƒÙ‡ ========== */
let score=0, gameTimer, timeLeft=30, gameActive=false, points=0, tickets=0, usdt=0;
const fruits=['ğŸ','ğŸŠ','ğŸŒ','ğŸ‡','ğŸ“','ğŸ’','ğŸ¥','ğŸ‘','ğŸ','ğŸ¥­','ğŸ‰','ğŸˆ','ğŸ','ğŸ‹','ğŸ¥¥','ğŸ¥‘','ğŸŒ½','ğŸ¥•','ğŸ¥”','ğŸ ','ğŸ¥’','ğŸ¥¬','ğŸ¥¦','ğŸ§„','ğŸ§…','ğŸ„','ğŸ¥œ','ğŸŒ°','ğŸ','ğŸ¥','ğŸ¥–','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ§ˆ','ğŸ¥','ğŸ§‡','ğŸ¥“','ğŸ”','ğŸŸ','ğŸ•','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸ§†','ğŸ¥™','ğŸ¥—','ğŸœ','ğŸ','ğŸ ','ğŸ¤','ğŸ£','ğŸ±','ğŸ›','ğŸš','ğŸ˜','ğŸ¥','ğŸ¥ ','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ¥§','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥›','ğŸ¼','â˜•','ğŸµ','ğŸ§ƒ','ğŸ¥¤','ğŸ§‹','ğŸ¶','ğŸº','ğŸ»','ğŸ¥‚','ğŸ·','ğŸ¥ƒ','ğŸ¸','ğŸ¹','ğŸ§‰','ğŸ¾','ğŸ§Š','ğŸ¥„','ğŸ´','ğŸ½ï¸','ğŸ¥£','ğŸ¥¡','ğŸ¥¢','ğŸ§‚'];
function createFruit(){
  if(!gameActive)return;
  const f=document.createElement('div'); f.className='fruit';
  f.textContent=fruits[Math.floor(Math.random()*fruits.length)];
  f.style.left=Math.random()*(window.innerWidth-60)+'px';
  f.style.animationDuration=(Math.random()*0.8+0.8)+'s';
  f.ontouchstart=f.onmousedown=function(e){
    e.preventDefault(); playPop(); score++;
    document.getElementById('score').textContent='Score: '+score;
    f.style.transform='scale(0)'; f.style.opacity='0';
    setTimeout(()=>f.remove(),150); return false;
  };
  document.body.appendChild(f); setTimeout(()=>f.remove(),1800);
}

async function startGame(){
  // Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ backend
  const gameStarted = await startGameSession();
  if (!gameStarted) {
    alert("Failed to start game session");
    return;
  }

  score=0; timeLeft=30; gameActive=true;
  document.getElementById('score').textContent='Score: 0';
  document.getElementById('timer').textContent=timeLeft;
  document.getElementById('gameScreen').style.display='flex';

  const fruitInterval=setInterval(()=>{
    if(!gameActive){clearInterval(fruitInterval);return;}
    createFruit();
  },33);

  gameTimer=setInterval(()=>{
    timeLeft--;
    document.getElementById('timer').textContent=timeLeft;
    if(timeLeft<=0){
      gameActive=false; clearInterval(gameTimer); clearInterval(fruitInterval);
      const gamePoints=score*2.5;
      points+=gamePoints;
      document.getElementById('points').textContent=points.toFixed(1);
      
      // Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¥Ù„Ù‰ backend
      endGameSession(score, gamePoints);
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      updateUserStats(points, usdt, tickets);
      
      showCongrats(gamePoints);
      setTimeout(()=>openPage('page1'),2500);
    }
  },1000);
}

function showCongrats(gamePoints){
  const msg=document.createElement('div');
  msg.innerHTML=`ğŸ‰ Congrats! You got <b>${gamePoints.toFixed(1)}</b> points!`;
  msg.style.cssText=`
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    background:rgba(0,0,0,.7); color:var(--accent); padding:15px 25px;
    border-radius:15px; font-size:20px; text-align:center; z-index:9999;
  `;
  document.body.appendChild(msg);
  setTimeout(()=>msg.remove(),2000);
}

/* ========== Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª ========== */
function openPage(pageId){
  const current=document.querySelector('.page.active');
  const next=document.getElementById(pageId);
  if(current===next)return;
  next.classList.remove('flip-in','flip-out');
  current.classList.add('flip-out');
  next.classList.add('flip-in','active');
  if(pageId==='game') startGame();
  if(pageId==='invite') loadInvite();
  setTimeout(()=>current.classList.remove('active','flip-out'),600);
}

/* ========== Referral Logic ========== */
function getRefParam() {
  // 1- Inside Telegram WebApp
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
    const sp = Telegram.WebApp.initDataUnsafe.start_param;
    if (sp && sp.startsWith('ref_')) {
      const ref = sp.replace('ref_', '');
      if (/^\d+$/.test(ref)) return ref;
    }
  }
  // 2- Browser fallback for testing (manual hash)
  if (location.hash.startsWith('#ref_')) {
    const ref = location.hash.split('#ref_')[1];
    if (/^\d+$/.test(ref)) return ref;
  }
  return null;
}

const ref = getRefParam();
if (ref) {
  registerReferral(ref);
}

/* ========== Invite Page ========== */
let inviteLink = '';
async function loadInvite(){
  inviteLink = await loadInviteData();
  if (!inviteLink) {
    // Fallback Ø¥Ø°Ø§ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† backend
    const uid = (Telegram.WebApp.initDataUnsafe?.user?.id) || 123456789;
    inviteLink = `https://t.me/Game_win_usdtBot/earn?startapp=ref_${uid}`;
  }
}

function copyInvite(){
  navigator.clipboard.writeText(inviteLink).then(()=>{
    const m = document.getElementById('copyMsg');
    m.style.opacity=1;
    setTimeout(()=>m.style.opacity=0, 1500);
  });
}

function shareInvite(){
  const text = `Join the game and earn tickets!`;
  const url = encodeURIComponent(inviteLink);
  Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${url}&text=${encodeURIComponent(text)}`);
}

/* ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ========== */
let adsReadyAfter=0, watching=false;
const adBtn=document.getElementById('adBtn');
async function watchAd(){
  const now = Date.now();
  if(watching || now < adsReadyAfter) return;
  watching=true;
  adBtn.disabled=true;
  
  const result = await watchAdComplete();
  if (result > 0) {
    tickets += result;
    document.getElementById('tickets').textContent = tickets;
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¹Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
    updateUserStats(points, usdt, tickets);
  }
  
  adsReadyAfter = Date.now() + 5000;
  watching=false;
  adBtn.disabled = false;
}

/* ========== Ø´Ø±Ø§Ø¡ ØªØ°Ø§ÙƒØ± ========== */
async function buyTickets(ticketAmount){
  let starCost=0;
  if(ticketAmount===500) starCost=10;
  else if(ticketAmount===2500) starCost=50;
  else if(ticketAmount===6000) starCost=100;

  if(points<starCost){
    alert(`You need ${starCost} â­ to buy ${ticketAmount} ğŸ«`);
    return;
  }
  
  const purchaseSuccess = await processPurchase(ticketAmount, starCost);
  if (purchaseSuccess) {
    points-=starCost;
    document.getElementById('points').textContent=points.toFixed(1);
    tickets+=ticketAmount;
    document.getElementById('tickets').textContent=tickets;
    alert(`You bought ${ticketAmount} ğŸ« successfully!`);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡
    updateUserStats(points, usdt, tickets);
  } else {
    alert("Purchase failed. Please try again.");
  }
}

/* ========== ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ°ÙƒØ±Ø© ========== */
function checkPlay(){
  if(tickets<=0){
    alert("You need at least 1 ticket to play!");
    return;
  }
  tickets--;
  document.getElementById('tickets').textContent=tickets;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¹Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©
  updateUserStats(points, usdt, tickets);
  
  openPage('game');
}

/* ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ========== */
async function initApp() {
  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
  await loadUserData();
  
  // ØªØ°Ø§ÙƒØ± Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  const gaveFirstTickets=localStorage.getItem("gaveFirstTickets");
  if(!gaveFirstTickets){
    tickets=3;
    localStorage.setItem("gaveFirstTickets","true");
    document.getElementById('tickets').textContent=tickets;
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø¹ Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
    updateUserStats(points, usdt, tickets);
  }
}

/* ========== Telegram Ready ========== */
Telegram.WebApp.ready();
Telegram.WebApp.expand();

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
window.addEventListener('load', initApp);
</script>
</body>
</html>