<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width,initial-scale=1,user-scalable=no" name="viewport"/>
  <title>Food Rain ‚Äì Telegram Invoice</title>
  <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400&display=swap" rel="stylesheet"/>
  <style>
    html,body{margin:0;height:100%;background:#000;font-family:'Kalam',cursive;color:#fff;touch-action:none;overflow:hidden}
    
    /* ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÄ topBar - ŸÜÿ≤ŸÑŸÜÿß ÿßŸÑÿ≤ÿ± ÿ¥ŸàŸä */
    #topBar{position:absolute;top:4px;left:0;right:0;display:flex;align-items:flex-start;justify-content:space-between;padding:0 12px;z-index:20}
    #topBar > div:first-child{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
    .lbl{font-size:18px}.val{font-size:20px;margin-left:4px}
    
    /* ÿ≤ÿ± ÿßŸÑÿ≥ÿ≠ÿ® - ŸÜÿ≤ŸÑŸÜÿßŸá ÿ¥ŸàŸä */
    #withdrawBtn{
      font-size:14px;padding:6px 14px;border:none;border-radius:6px;
      background:linear-gradient(145deg,#fff,#d1d1d1);color:#000;cursor:pointer;
      box-shadow:3px 3px 6px #222,-3px -3px 6px #444;
      transition:transform .15s ease;margin-top:4px
    }
    #withdrawBtn:active{transform:translateZ(-6px);box-shadow:inset 2px 2px 4px #222,inset -2px -2px 4px #444}

    /* ÿØÿßÿ¶ÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ - ÿ®ÿ™ÿÆÿ™ŸÅŸä ÿßÿ´ŸÜÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ© */
    #userCard{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      display:flex;flex-direction:column;align-items:center;gap:6px;z-index:15;
      transition:opacity .3s ease
    }
    #userCard.hidden{opacity:0;pointer-events:none}
    #userCard img{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid #666}
    #userCard #firstName{font-size:17px;color:#fff}
    #userCard #username{font-size:14px;color:#aaa}
    #userCard #userId{font-size:12px;color:#888}

    #btnRow{position:absolute;bottom:12px;left:0;right:0;display:flex;justify-content:center;align-items:center;gap:12px;z-index:10}
    .btn3d{padding:8px 18px;font-size:15px;border:none;border-radius:6px;background:linear-gradient(145deg,#fff,#d1d1d1);color:#000;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease;box-shadow:6px 6px 12px #222,-6px -6px 12px #444}
    .btn3d:active{transform:translateZ(-12px);box-shadow:inset 4px 4px 8px #222,inset -4px -4px 8px #444}

    #swapPage{position:fixed;inset:0;background:#111;display:none;flex-direction:column;align-items:center;justify-content:center;padding:40px 12px 80px;gap:25px;z-index:150}
    .field-card{background:#1e1e1e;padding:18px 24px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.4);width:90%;max-width:420px}
    .field-label{font-size:18px;margin-bottom:8px;display:block}
    .field-input{width:100%;padding:10px 14px;font-size:16px;border:none;border-radius:8px;background:#2a2a2a;color:#fff;box-shadow:inset 2px 2px 4px #111,inset -2px -2px 4px #333;outline:none}
    #usdtPreview{margin-top:8px;font-size:16px;color:#00ff88}
    .submitBtn{padding:14px 40px;font-size:18px;border:none;border-radius:10px;background:linear-gradient(145deg,#fff,#d1d1d1);color:#000;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease;box-shadow:6px 6px 12px #222,-6px -6px 12px #444}
    .submitBtn:active{transform:translateZ(-12px);box-shadow:inset 4px 4px 8px #222,inset -4px -4px 8px #444}

    #addTaskPage{position:fixed;inset:0;background:#111;display:none;flex-direction:column;align-items:center;justify-content:center;padding:40px 12px 80px;gap:25px;z-index:150}
    .users-selector{display:flex;justify-content:space-around;gap:12px;margin-top:10px}
    .users-btn{flex:1;padding:10px 0;font-size:16px;border:none;border-radius:8px;background:linear-gradient(145deg,#fff,#d1d1d1);color:#000;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease;box-shadow:4px 4px 8px #111,-4px -4px 8px #333}
    .users-btn:active{transform:translateZ(-10px);box-shadow:inset 2px 2px 4px #111,inset -2px -2px 4px #333}
    .users-btn.selected{background:#00ff88;color:#000}

    #noTicketPopup{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;display:none;justify-content:center;align-items:center}
    #noTicketPopup>div{background:#1e1e1e;padding:20px 30px;border-radius:12px;text-align:center;box-shadow:0 0 20px #000;color:#fff;font-size:18px}

    #tasksOnly{position:fixed;inset:0;background:#111;display:none;flex-direction:column;align-items:center;padding:40px 12px 80px;gap:20px;z-index:100;overflow-y:auto;touch-action:pan-y}
    .task-card{display:flex;align-items:center;gap:12px;background:#1e1e1e;padding:14px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.35);width:90%;max-width:400px}
    .task-card .icon{font-size:28px}.task-card .txt{flex:1;font-size:18px}
    .btnJoin,.adBtn3d{padding:6px 16px;font-size:15px;border:none;border-radius:6px;background:linear-gradient(145deg,#fff,#d1d1d1);color:#000;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease;box-shadow:4px 4px 8px #111,-4px -4px 8px #333}
    .btnJoin:active,.adBtn3d:active{transform:translateZ(-10px);box-shadow:inset 2px 2px 4px #111,inset -2px -2px 4px #333}

    #backBtn{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);padding:8px 24px;font-size:15px;border:none;border-radius:6px;background:linear-gradient(145deg,#fff,#d1d1d1);color:#000;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease;box-shadow:6px 6px 12px #222,-6px -6px 12px #444;z-index:200;display:none}
    #backBtn:active{transform:translateX(-50%) translateZ(-12px);box-shadow:inset 4px 4px 8px #222,inset -4px -4px 8px #444}

    .food{position:absolute;font-size:40px;cursor:pointer;user-select:none;animation:fall 3s linear forwards}
    @keyframes fall{to{transform:translateY(110vh)}}
    .pop{position:absolute;width:8px;height:8px;background:#ffae00;border-radius:50%;animation:pop .4s ease-out forwards}
    @keyframes pop{to{transform:scale(20);opacity:0}}
  </style>
</head>
<body>

<!-- Top Bar -->
<div id="topBar">
  <div>
    <div><span class="lbl">Time</span><span class="val" id="timer">30</span>s</div>
    <button id="withdrawBtn">Withdraw</button>
  </div>
  <div><span class="lbl">USDT</span><span class="val" id="usdt">0</span></div>
  <div><span class="lbl">Ticket</span><span class="val" id="ticket">0</span></div>
  <div><span class="lbl">Score</span><span class="val" id="score">0</span></div>
</div>

<!-- User Card -->
<div id="userCard">
  <img id="userImg" src="" alt=""/>
  <div id="firstName"></div>
  <div id="username"></div>
  <div id="userId"></div>
</div>

<!-- Bottom Buttons -->
<div id="btnRow">
  <button id="tasksBtn" class="btn3d">TASKS</button>
  <button id="playBtn" class="btn3d">PLAY</button>
  <button id="addTaskBtn" class="btn3d">ADD+TASK</button>
  <button id="swapBtn" class="btn3d">üí±</button>
</div>

<!-- Swap Page -->
<div id="swapPage" style="display:none">
  <div class="field-card">
    <label class="field-label">Swap Score to USDT</label>
    <input id="swapInput" class="field-input" placeholder="Enter score" type="number" min="200000"/>
    <div id="usdtPreview">0 USDT</div>
  </div>
  <button id="confirmSwapBtn" class="submitBtn">Confirm Swap</button>
</div>

<!-- Add Task Page -->
<div id="addTaskPage" style="display:none">
  <div class="field-card"><label class="field-label">Task Name</label><input id="taskNameInput" class="field-input" placeholder="e.g. Join Channel" type="text"/></div>
  <div class="field-card"><label class="field-label">Channel / Bot Link</label><input id="taskLinkInput" class="field-input" placeholder="https://t.me/YourChannel" type="url"/></div>
  <div class="field-card"><label class="field-label">Required Users</label>
    <div class="users-selector">
      <button class="users-btn" data-users="100">100</button>
      <button class="users-btn" data-users="200">200</button>
      <button class="users-btn" data-users="500">500</button>
    </div>
  </div>
  <button id="submitTaskBtn" class="submitBtn">Create Task</button>
</div>

<!-- Tasks Container -->
<div id="tasksOnly" style="display:none">
  <div class="task-card"><span class="icon">üì¢</span><span class="txt">Join our channel (+10üéü)</span><button class="btnJoin" id="joinBtn">Join</button></div>
  <div class="task-card"><span class="icon">üì∫</span><span class="txt">Watch 300 ads (<span id="adsLeft">300</span> left)</span><button class="adBtn3d" id="watchAdBtn">+1üéü</button></div>
</div>

<!-- No-Ticket Popup -->
<div id="noTicketPopup">
  <div>‚ùå You don't have enough tickets<br><button onclick="closeNoTicketPopup()" style="margin-top:12px;padding:6px 18px;font-size:16px;border:none;border-radius:8px;background:linear-gradient(145deg,#fff,#d1d1d1);color:#000;cursor:pointer;">Close</button></div>
</div>

<!-- Back Button -->
<button id="backBtn">Back</button>

<audio id="popSound" preload="auto" volume="0.5"></audio>

<script>
  const popSrc="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE";
  document.getElementById('popSound').src=popSrc;

  const foods=['üçï','üçî','üçü','üå≠','ü•™','üåÆ','üåØ','ü•ô','üç£','üç±','üçú','üçù','üç©','üç™','üç∞','üßÅ','üçÆ','üç°','üç•','ü•ü'];
  let timeLeft=30,gameInterval,timerInterval;
  const timerEl=document.getElementById('timer');
  const scoreEl=document.getElementById('score');
  const usdtEl=document.getElementById('usdt');
  const ticketEl=document.getElementById('ticket');
  const playBtn=document.getElementById('playBtn');
  const tasksBtn=document.getElementById('tasksBtn');
  const addTaskBtn=document.getElementById('addTaskBtn');
  const swapBtn=document.getElementById('swapBtn');
  const tasksOnly=document.getElementById('tasksOnly');
  const backBtn=document.getElementById('backBtn');
  const joinBtn=document.getElementById('joinBtn');
  const watchAdBtn=document.getElementById('watchAdBtn');
  const adsLeftEl=document.getElementById('adsLeft');
  const addTaskPage=document.getElementById('addTaskPage');
  const taskNameInput=document.getElementById('taskNameInput');
  const taskLinkInput=document.getElementById('taskLinkInput');
  const submitTaskBtn=document.getElementById('submitTaskBtn');
  const usersBtns=document.querySelectorAll('.users-btn');
  const noTicketPopup=document.getElementById('noTicketPopup');
  const swapPage=document.getElementById('swapPage');
  const swapInput=document.getElementById('swapInput');
  const confirmSwapBtn=document.getElementById('confirmSwapBtn');
  const usdtPreview=document.getElementById('usdtPreview');
  const userCard=document.getElementById('userCard');

  let totalScore=0;
  let ticketLeft=0;
  let adsLeft=300;
  let joined=false;
  let adBlock=false;
  let selectedUsers=100;

  scoreEl.textContent=totalScore;
  ticketEl.textContent=ticketLeft;

  /* ===== fill user data ===== */
  function fillUserData(){
    if(!window.Telegram||!window.Telegram.WebApp){
      document.getElementById('userImg').src='https://i.pravatar.cc/80?u=demo';
      document.getElementById('firstName').textContent='Demo';
      document.getElementById('username').textContent='@demo_user';
      document.getElementById('userId').textContent='123456';
      return;
    }
    const u=window.Telegram.WebApp.initDataUnsafe.user;
    if(!u){alert('User object not found');return;}
    document.getElementById('userImg').src=u.photo_url||'https://i.pravatar.cc/80?u='+u.id;
    document.getElementById('firstName').textContent=u.first_name||'';
    document.getElementById('username').textContent=u.username?'@'+u.username:'No username';
    document.getElementById('userId').textContent=u.id||'';
  }
  fillUserData();

  /* ===== users selector ===== */
  usersBtns.forEach(btn=>{
    btn.addEventListener('click',()=>{
      usersBtns.forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedUsers=parseInt(btn.dataset.users);
    });
  });
  usersBtns[0].classList.add('selected');

  /* ===== Withdraw Button ===== */
  document.getElementById('withdrawBtn').addEventListener('click',()=>{
    alert('Withdraw feature coming soon!');
  });

  /* ===== actions ===== */
  playBtn.addEventListener('click',()=>{
    if(ticketLeft<=0){showNoTicketPopup();return;}
    ticketLeft--;ticketEl.textContent=ticketLeft;
    fetch('/api/play',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:1,action:'play'})}).catch(console.error);
    startGame();
  });

  tasksBtn.addEventListener('click',()=>{
    fetch('/api/openTasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:1,action:'openTasks'})}).catch(console.error);
    openTasks();
  });

  addTaskBtn.addEventListener('click',()=>{
    fetch('/api/openAddTask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:1,action:'openAddTask'})}).catch(console.error);
    openAddTask();
  });

  swapBtn.addEventListener('click',()=>{
    fetch('/api/openSwap',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:1,action:'openSwap'})}).catch(console.error);
    openSwap();
  });

  confirmSwapBtn.addEventListener('click',()=>{
    const amount=parseInt(swapInput.value);
    if(!amount||amount<=0||amount>totalScore){alert('Invalid or insufficient score');return;}
    if(amount<200000){alert('Minimum swap is 200,000 score');return;}
    fetch('/api/swap',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:1,action:'swap',amount})})
      .then(res=>{if(!res.ok)throw new Error('Server returned '+res.status);})
      .then(()=>{
        totalScore-=amount;
        scoreEl.textContent=totalScore;
        usdtEl.textContent=(parseFloat(usdtEl.textContent)+amount*0.01/200000).toFixed(6);
        alert(`‚úÖ Swapped ${amount} score`);
        closeSwap();
      })
      .catch(err=>{console.error(err);alert('‚ùå Swap failed, please try again');});
  });

  swapInput.addEventListener('input',()=>{
    const score=parseInt(swapInput.value)||0;
    const usdt=(score*0.01/200000).toFixed(6);
    usdtPreview.textContent=`${usdt} USDT`;
  });

  submitTaskBtn.addEventListener('click',()=>{
    const name=taskNameInput.value.trim();
    const link=taskLinkInput.value.trim();
    if(!name||!link){alert('Please fill all fields');return;}
    const price=Math.floor(selectedUsers/100)*50;
    createTelegramInvoice(name,link,price);
  });

  joinBtn.addEventListener('click',()=>{
    if(joined)return;
    joined=true;ticketLeft+=10;ticketEl.textContent=ticketLeft;
    joinBtn.textContent='‚úÖ Done';joinBtn.disabled=true;
    fetch('/api/joinChannel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:1,action:'joinChannel',ticketLeft})}).catch(console.error);
  });

  watchAdBtn.addEventListener('click',()=>{
    if(adsLeft<=0||adBlock)return;
    adBlock=true;
    setTimeout(()=>{
      ticketLeft++;ticketEl.textContent=ticketLeft;
      adsLeft--;adsLeftEl.textContent=adsLeft;
      if(adsLeft<=0){
        watchAdBtn.textContent='‚è≥ 15h wait';watchAdBtn.disabled=true;
        setTimeout(()=>{adsLeft=300;adsLeftEl.textContent=adsLeft;watchAdBtn.textContent='+1üéü';watchAdBtn.disabled=false;},54000000);
      }
      adBlock=false;
      fetch('/api/watchAd',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:1,action:'watchAd',ticketLeft,adsLeft})}).catch(console.error);
    },1000);
  });

  backBtn.addEventListener('click',()=>{
    fetch('/api/back',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:1,action:'back'})}).catch(console.error);
    closeTasks();closeAddTask();closeSwap();
  });

  /* ===== Telegram Invoice ===== */
  function createTelegramInvoice(name,link,price){
    if(!window.Telegram||!window.Telegram.WebApp){alert('Telegram WebApp ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠');return;}
    const payload={
      title:name,
      description:'Community task for '+selectedUsers+' users',
      currency:'XTR',
      prices:[{label:name,amount:price}],
      start_param:'task_'+Date.now(),
      provider_token:'',
      suggested_tip_amounts:[],
      max_tip_amount:0,
      is_flexible:false,
      need_name:false,
      need_phone_number:false,
      need_email:false,
      need_shipping_address:false,
      send_email_to_provider:false,
      send_phone_number_to_provider:false
    };
    window.Telegram.WebApp.openInvoice(payload,function(status){
      if(status==='paid'){
        addCommunityTask(name,link,selectedUsers);
        ticketLeft+=15;
        ticketEl.textContent=ticketLeft;
        alert('‚úÖ Paid! Task added & +15 Ticket awarded.');
      }else if(status==='failed'){
        alert('‚ùå Payment failed');
      }else if(status==='cancelled'){
        alert('‚ùå Payment cancelled');
      }
    });
  }

  /* ===== popups ===== */
  function showNoTicketPopup(){
    noTicketPopup.style.display='flex';
  }
  function closeNoTicketPopup(){
    noTicketPopup.style.display='none';
  }

  /* ===== add community task (+15 Ticket) ===== */
  function addCommunityTask(name,link,required){
    const card=document.createElement('div');
    card.className='task-card';
    card.innerHTML=`
      <span class="icon">üìÑ</span>
      <span class="txt">${name} (+15üéü)</span>
      <button class="btnJoin" onclick="joinCommunityTask('${name}','${link}')">Join</button>
    `;
    tasksOnly.appendChild(card);
  }
  function joinCommunityTask(name,link){
    window.open(link,'_blank');
    ticketLeft+=15;
    ticketEl.textContent=ticketLeft;
    fetch('/api/joinCommunityTask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:1,action:'joinCommunityTask',taskName:name})}).catch(console.error);
  }

  /* ===== pages ===== */
  function openTasks(){
    document.getElementById('topBar').style.display='none';
    document.getElementById('btnRow').style.display='none';
    tasksOnly.style.display='flex';
    backBtn.style.display='block';
  }
  function closeTasks(){
    tasksOnly.style.display='none';
    backBtn.style.display='none';
    document.getElementById('topBar').style.display='flex';
    document.getElementById('btnRow').style.display='flex';
  }
  function openAddTask(){
    document.getElementById('topBar').style.display='none';
    document.getElementById('btnRow').style.display='none';
    addTaskPage.style.display='flex';
    backBtn.style.display='block';
  }
  function closeAddTask(){
    addTaskPage.style.display='none';
    backBtn.style.display='none';
    document.getElementById('topBar').style.display='flex';
    document.getElementById('btnRow').style.display='flex';
  }
  function openSwap(){
    document.getElementById('topBar').style.display='none';
    document.getElementById('btnRow').style.display='none';
    swapPage.style.display='flex';
    backBtn.style.display='block';
  }
  function closeSwap(){
    swapPage.style.display='none';
    backBtn.style.display='none';
    document.getElementById('topBar').style.display='flex';
    document.getElementById('btnRow').style.display='flex';
  }

  /* ===== game ===== */
  function startGame(){
    timeLeft=30;timerEl.textContent=timeLeft;
    document.getElementById('btnRow').style.display='none';
    backBtn.style.display='none';
    
    // ÿ•ÿÆŸÅÿßÿ° ÿØÿßÿ¶ÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    userCard.classList.add('hidden');
    
    gameInterval=setInterval(()=>launchWave(),40);
    timerInterval=setInterval(()=>{
      timeLeft--;
      timerEl.textContent=timeLeft;
      if(timeLeft<=0)finishRound();
    },1000);
  }
  function launchWave(){
    for(let i=0;i<4;i++){
      const f=document.createElement('span');
      f.className='food';
      f.textContent=foods[Math.floor(Math.random()*foods.length)];
      f.style.left=(Math.random()*95)+'%';
      f.style.top='-60px';
      document.body.appendChild(f);
      f.addEventListener('click',collect);
      f.addEventListener('touchstart',collect,{passive:true});
      setTimeout(()=>f.remove(),3000);
    }
  }
  function collect(e){
    e.stopPropagation();
    const elem=e.currentTarget;
    for(let i=0;i<8;i++){
      const p=document.createElement('span');
      p.className='pop';
      const rect=elem.getBoundingClientRect();
      p.style.left=(rect.left+rect.width/2)+'px';
      p.style.top=(rect.top+rect.height/2)+'px';
      p.style.transform=`rotate(${i*45}deg) translateX(30px)`;
      document.body.appendChild(p);
      setTimeout(()=>p.remove(),400);
    }
    const snd=document.getElementById('popSound').cloneNode();
    snd.volume=0.5;
    snd.play();
    totalScore++;
    scoreEl.textContent=totalScore;
    fetch('/api/collect',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:1,action:'collect',emoji:elem.textContent,totalScore})}).catch(console.error);
    elem.remove();
  }
  function finishRound(){
    clearInterval(gameInterval);
    clearInterval(timerInterval);
    document.querySelectorAll('.food').forEach(f=>f.remove());
    document.querySelectorAll('.pop').forEach(p=>p.remove());
    document.getElementById('btnRow').style.display='flex';
    backBtn.style.display='none';
    
    // ÿ•ÿ∏Ÿáÿßÿ± ÿØÿßÿ¶ÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ
    userCard.classList.remove('hidden');
    
    closeTasks();closeAddTask();closeSwap();
  }

</script>
</body>
</html>
